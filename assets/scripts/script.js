const menu = {
    "": {},
    "Entrées:": {
        "Vegetable Stir-Fry with Tofu": {
            "price": 5.5,
            "diets": ["V+"],
            "rating": 4.6,
            "desc": "A mix of colorful vegetables sautéed with tofu in a savory soy-ginger sauce."
        },
        "Chickpea Curry": {
            "price": 4.7,
            "diets": ["V+"],
            "rating": 4.8,
            "desc": "A rich and flavorful Indian-style curry made with chickpeas, tomatoes, and warm spices."
        },
        "Mushroom Risotto": {
            "price": 6.2,
            "diets": ["LV"],
            "rating": 4.7,
            "desc": "Creamy Arborio rice cooked slowly with mushrooms, garlic, and parmesan cheese."
        },
        "Eggplant Parmesan": {
            "price": 6.0,
            "diets": ["LV"],
            "rating": 4.5,
            "desc": "Breaded and baked eggplant slices layered with marinara sauce and mozzarella cheese."
        },
        "Stuffed Bell Peppers": {
            "price": 5.0,
            "diets": ["V+"],
            "rating": 4.4,
            "desc": "Bell peppers filled with a mixture of rice, black beans, corn, and spices."
        },
        "Lentil Shepherd’s Pie": {
            "price": 5.8,
            "diets": ["V+"],
            "rating": 4.6,
            "desc": "A comforting dish made with lentils, vegetables, and mashed potatoes."
        },
        "Pasta Primavera": {
            "price": 5.2,
            "diets": ["V+"],
            "rating": 4.3,

            "desc": "A light pasta dish tossed with seasonal vegetables and olive oil."
        },
        "Spinach and Ricotta Stuffed Shells": {
            "price": 6.5,
            "diets": ["LV"],
            "rating": 4.6,
            "desc": "Large pasta shells filled with ricotta cheese and spinach, baked in tomato sauce."
        },
        "Sweet Potato and Black Bean Tacos": {
            "price": 4.9,
            "diets": ["V+"],
            "rating": 4.7,
            "desc": "Roasted sweet potatoes and black beans served in corn tortillas with avocado."
        },
        "Vegetable Pad Thai": {
            "price": 5.5,
            "diets": ["V+"],
            "rating": 4.5,
            "desc": "A classic Thai noodle dish with stir-fried vegetables, tofu, and a tangy peanut sauce."
        },
        "Caprese Pasta": {
            "price": 6.0,
            "diets": ["LV"],
            "rating": 4.4,
            "desc": "A simple pasta dish with cherry tomatoes, basil, mozzarella, and balsamic glaze."
        },
        "Chana Masala": {
            "price": 5.0,
            "diets": ["V+"],
            "rating": 4.8,
            "desc": "A hearty chickpea dish cooked in a spiced tomato-based sauce."
        },
        "Vegetable Korma": {
            "price": 5.7,
            "diets": ["LV"],
            "rating": 4.7,
            "desc": "A creamy Indian curry made with vegetables, cashews, and coconut milk."
        },
        "Zucchini Noodles with Pesto": {
            "price": 5.3,
            "diets": ["V+"],
            "rating": 4.6,
            "desc": "Spiralized zucchini tossed with fresh basil pesto and cherry tomatoes."

        },
        "Vegetable Lasagna": {
            "price": 6.8,
            "diets": ["LV"],
            "rating": 4.5,
            "desc": "Layers of pasta, ricotta, spinach, and marinara sauce baked to perfection."
        },
        "Egg Salad Sandwich": {
            "price": 4.5,
            "diets": ["OV"],
            "rating": 4.3,
            "desc": "A creamy and flavorful egg salad served between slices of whole-grain bread."
        },
        "Shakshuka": {
            "price": 5.5,
            "diets": ["OV"],
            "rating": 4.6,
            "desc": "Poached eggs in a spiced tomato and pepper sauce, served with crusty bread."
        },
        "Tofu Scramble": {
            "price": 5.0,
            "diets": ["V+"],
            "rating": 4.7,
            "desc": "A vegan alternative to scrambled eggs, made with seasoned tofu and vegetables."
        },
        "Paneer Tikka Masala": {
            "price": 6.5,
            "diets": ["LV"],
            "rating": 4.8,
            "desc": "A rich Indian curry made with grilled paneer cubes in a creamy tomato sauce."
        },
        "Black Bean Burgers": {
            "price": 5.2,
            "diets": ["V+"],
            "rating": 4.6,
            "desc": "Homemade black bean patties served on a bun with lettuce, tomato, and avocado."
        }
    },

    "Sides:": {
        "Garlic Roasted Brussels Sprouts": {
            "price": 4.7,
            "diets": ["V+"],
            "rating": 4.6,
            "desc": "Crispy roasted Brussels sprouts tossed with garlic and olive oil."
        },
        "Spiced Sweet Potato Wedges": {
            "price": 4.7,
            "diets": ["V+"],
            "rating": 4.7,
            "desc": "Oven-baked sweet potato wedges seasoned with paprika and cumin."
        },
        "Cheesy Spinach Stuffed Mushrooms": {
            "price": 4.7,
            "diets": ["LV"],
            "rating": 4.5,
            "desc": "Mushrooms stuffed with a creamy spinach and cheese filling."
        },
        "Egg and Avocado Salad": {
            "price": 4.7,
            "diets": ["OV"],
            "rating": 4.5,
            "desc": "A refreshing salad with mashed avocado, boiled eggs, and lemon juice."
        },
        "Crispy Tofu Bites": {
            "price": 4.7,
            "diets": ["V+"],
            "rating": 4.6,
            "desc": "Golden crispy tofu bites seasoned with garlic and soy sauce."
        },
        "Parmesan Garlic Green Beans": {
            "price": 4.7,
            "diets": ["LV"],
            "rating": 4.7,
            "desc": "Tender green beans tossed in garlic butter and topped with parmesan cheese."
        },
        "Chili Lime Grilled Corn": {
            "price": 4.7,
            "diets": ["V+"],
            "rating": 4.6,
            "desc": "Grilled corn on the cob with a zesty chili lime seasoning."
        },
        "Classic Deviled Eggs": {

            "price": 4.7,
            "diets": ["OV"],
            "rating": 4.5,
            "desc": "Hard-boiled eggs filled with a creamy mustard and paprika filling."
        },
        "Roasted Garlic Mashed Potatoes": {
            "price": 4.7,
            "diets": ["LV"],
            "rating": 4.8,
            "desc": "Creamy mashed potatoes blended with roasted garlic and butter."
        },
        "Balsamic Glazed Carrots": {
            "price": 4.7,
            "diets": ["V+"],
            "rating": 4.7,
            "desc": "Oven-roasted carrots drizzled with a tangy balsamic glaze."
        },
        "Creamy Coleslaw": {
            "price": 4.7,
            "diets": ["LV"],
            "rating": 4.6,
            "desc": "Shredded cabbage and carrots in a creamy mayo-based dressing."
        },
        "Garlic Butter Mushrooms": {
            "price": 4.7,
            "diets": ["LV"],
            "rating": 4.7,
            "desc": "Sautéed mushrooms in a rich garlic butter sauce with fresh parsley."
        },
        "Quinoa Tabbouleh Salad": {
            "price": 4.7,
            "diets": ["V+"],
            "rating": 4.6,
            "desc": "A refreshing mix of quinoa, parsley, tomatoes, cucumbers, and lemon dressing."
        }
    },

    "Drinks:": {
        "Green Detox Smoothie": {
            price: 5.0,
            diets: ["V+", "GF"],
            rating: 4.7,
            desc: "A refreshing blend of kale, spinach, apple, and lime, perfect for a nutrient-packed start to your day."
        },
        "Golden Turmeric Latte": {
            price: 4.5,
            diets: ["V+", "OV"],
            rating: 4.8,
            desc: "A warm and creamy drink made with turmeric, almond milk, and a touch of cinnamon for added flavor."
        },
        "Berry Bliss Smoothie": {
            price: 4.7,
            diets: ["V+", "GF"],
            rating: 4.6,
            desc: "A sweet and tangy mix of strawberries, blueberries, and raspberries blended with coconut water."
        },
        "Matcha Almond Latte": {
            price: 5.2,
            diets: ["V+", "OV", "GF"],
            rating: 4.9,
            desc: "An energizing latte made with ceremonial-grade matcha, almond milk, and a hint of vanilla."
        },
        "Choco-Banana Shake": {
            price: 4.8,
            diets: ["V+", "OV"],
            rating: 4.7,
            desc: "A creamy blend of bananas, cocoa powder, and oat milk, perfect for satisfying your sweet cravings."
        },
        "Cucumber Mint Cooler": {
            price: 4.3,
            diets: ["V+", "GF"],
            rating: 4.4,
            desc: "A light and refreshing drink made with cucumber, mint, lemon, and sparkling water."
        }
    },

    "Desserts: ": {
        "Classic Tiramisu": {
            price: 6.0,
            diets: ["LV"],
            rating: 4.8,
            desc: "A creamy Italian dessert made with layers of mascarpone, espresso-soaked ladyfingers, and cocoa."
        },
        "Vegan Chocolate Avocado Mousse": {
            price: 5.5,
            diets: ["V+", "GF"],
            rating: 4.9,
            desc: "A rich and creamy mousse made with ripe avocados, cocoa powder, and a touch of maple syrup."
        },
        "Raspberry Chia Pudding": {
            price: 4.7,
            diets: ["V+", "GF"],
            rating: 4.6,
            desc: "A wholesome and fruity dessert made with chia seeds, almond milk, and fresh raspberries."
        },
        "Carrot Cake Energy Bites": {
            price: 3.9,
            diets: ["V+", "GF"],
            rating: 4.5,
            desc: "A bite-sized dessert made with carrots, oats, nuts, and warm spices, perfect for a healthy treat."
        },
        "Strawberry Cheesecake": {
            price: 5.8,
            diets: ["OV"],
            rating: 4.7,
            desc: "A creamy cheesecake with a sweet strawberry topping and a buttery graham cracker crust."
        },
        "Peanut Butter Banana Nice Cream": {
            price: 4.2,
            diets: ["V+", "GF"],
            rating: 4.8,
            desc: "A dairy-free, naturally sweetened frozen dessert made with bananas and peanut butter."
        },
        "Matcha Green Tea Cookies": {
            price: 3.8,
            diets: ["OV"],
            rating: 4.5,
            desc: "Soft and chewy cookies infused with the earthy flavor of matcha, perfect for tea lovers."
        },
        "Coconut Mango Tapioca Pudding": {
            price: 5.0,
            diets: ["V+", "GF"],
            rating: 4.6,
            desc: "A tropical dessert made with tapioca pearls, coconut milk, and fresh mango chunks."
        },
        "Vegan Brownies": {
            price: 4.9,
            diets: ["V+", "GF"],
            rating: 4.9,
            desc: "Rich and fudgy brownies made with cocoa powder, almond flour, and coconut oil, perfect for chocolate lovers."
        }
    }
};

const touchscreen = (('ontouchstart' in window) ||
    (navigator.maxTouchPoints > 0) ||
    (navigator.msMaxTouchPoints > 0));

const qs = i => { return document.querySelector(i) };
const qsa = i => { return document.querySelectorAll(i) };
const encode = i => { return btoa(btoa(btoa(btoa(btoa(btoa(btoa(i))))))) };
const decode = i => { return atob(atob(atob(atob(atob(atob(atob(i))))))) };


function detect_from_to() {

    const if_from_then = [
        ["signup", "login", () => {
            qs('#signup-form-container').style.display = "block";
            setTimeout(() => {
                qs('#signup-form-container').style.display = "none"
            }, 1000);
        }]
        ,
        ["login", "signup", () => {
            qs('#login-form-container').style.display = "block";
            setTimeout(() => {
                qs('#login-form-container').style.display = "none"
            }, 1000);
        }]
    ];
    var page_name = window.location.pathname.split('/')[window.location.pathname.split('/').length - 1].split('.html')[0];

    for (let i of if_from_then) {
        if (i[0] == sessionStorage.from && i[1] == page_name) {
            i[2]();
        }
    }

    sessionStorage.setItem('from', page_name);
}

detect_from_to();

//login functionality

function capitalize(str) {
    var sections = str.toString().split(' ');
    res = "",
        count = 0;

    sections.forEach(e => {
        count++
        var list = e.toString().split(''),
            capital = list[0].toUpperCase();
        list.splice(0, 1);
        res += (count != 1 ? " " : "") + capital + list.join('');
    })

    return res;
}

async function fetchNcheck(u, p, file, check = true) {
    let x = await fetch(file);
    let y = { ...await x.json(), ...JSON.parse(localStorage.getItem('new_logins') || "{}") };
    if (check) {
        checkInfo(u, p, await y);
    } else return await y;
}
function checkInfo(u, p, logins) {
    //so that every time the info is checked, it is as if you are re-logging in
    sessionStorage.removeItem('loggedin');

    for (let [key, val] of Object.entries(logins)) {
        var k = key,
            v = val.pw;

        try {
            k = decode(k);
            v = decode(v);
        } catch (e) {
            console.error(e)
            console.log(k, v)
            return
        }

        //console.log(k, v); //displays all un/pw combinations

        if (u == k && p == v) {
            if (window.location.href.split('login.html').length > 1) {
                window.location = redirect ? `/${redirect}` : 'index.html';
            }
            window.sessionStorage.setItem('username', key);
            window.sessionStorage.setItem('password', val.pw);
            window.sessionStorage.setItem('pfp', val.pfp);
            window.sessionStorage.setItem('loggedin', true);
            break;
        } //else alert(`${u} is not equal to ${k}\nor\n${p} is not equal to ${v}`); //this was for testing purposes
    }
    if (!sessionStorage.loggedin) {
        alert('Invalid username or password');
        logout();
    }
}

function logout() {
    window.location = "login.html";
    sessionStorage.clear();
}

function guest() {
    var logins;
    fetchNcheck('guest', 'password', 'assets/ad83rdk.json');
}

function detect_hacking() {
    try {
        fetchNcheck(decode(sessionStorage.username), decode(sessionStorage.password), 'assets/ad83rdk.json');
    } catch (e) { //error: cannot properly decode username or password
        if (!sessionStorage.username || !sessionStorage.password) return; //so that it doesn't detect hacking when just logged out
        console.warn("Username or Password are not encoded properly; hacking detected");
        alert("Username or Password are not encoded properly; hacking detected");
        logout();
    }
}
login_dropdown();
if (sessionStorage.loggedin) {
    qs('#account-container span').innerHTML = `<img id="pfp" src="${decode(sessionStorage.pfp)}"> ${capitalize(decode(sessionStorage.username))}`;
    detect_hacking();
    window.addEventListener('click', detect_hacking);
}

//logo click functionality
qs('#go-home').addEventListener('click', () => window.location = 'index.html');

//sign up functionality
async function addCredentials(u, p) {
    var new_logins = JSON.parse(localStorage.getItem("new_logins") || "{}");
    var all_logins = await fetchNcheck(u, p, "assets/ad83rdk.json", false);
    if (!(await all_logins[encode(u)])) {
        new_logins[encode(u)] = { pw: encode(p), pfp: encode("img/Lahani Logo.png") };
    }

    localStorage.setItem("new_logins", JSON.stringify(new_logins));
    window.location = "login.html";
}

function price_format(n) {
    n = Math.round(n * 100) / 100; //reduce decimal points

    var input = n.toString(),
        changed,
        z = (n) => { var res = ''; for (let i of new Array(n)) res += "0"; return res };


    var after_dec = (input).split('.')[1] || "00";
    if (after_dec.length < 2) { //if number, without decimal points, has under 3 characters
        changed = input + z(2 - after_dec.length) //add zeroes
    } else changed = input

    if (!(input).split('.')[1]) changed += "00"

    if (changed.split('.').length <= 1) { //if isn't already decimal
        changed = changed.split('');
        changed.splice(changed.length - 2, 0, ".");
        changed = changed.join('');
    }
    changed = "$" + changed; //add unit


    return changed;
}

function diet_labels(diets, name) {
    var result = "";
    var key = { "V": "Standard Vegetarian", "OV": "Ovo-Vegetarian", "LV": "Lacto-Vegetarian", "V+": "Vegan", "SV": "Semi-Vegetarian", "GF": "Gluten Free" }
    for (let diet of diets) {
        if (key[diet]) {
            result += `<span title="${key[diet]}" class="diet ${diet.replace('+', 'P')}" ${touchscreen && "onclick='alert(" + key[diet] + ")'"}>${diet}</span>` + '&nbsp;'
        }
        else console.warn(`Warning: undefined diet '${diet}' at meal '${name}'`);
    }
    return result
}

function stars(rating) {
    var result = "";
    for (let i = 0.5; i <= rating; i += 0.5) {
        if (i % 1 == 0) { // if i is on a .0 
            result += `<img class="star" src="img/full_star.png" draggable="false" alt="star ">`;
        }
        else { // if i is on a .5
            if (rating == i) {
                result += `<img class="star" src="img/half_star.png" draggable="false" alt="half star ">`;
            }
        }
    }
    return result
}

function desc_format(desc) {
    var x = desc.split('');
    x.splice(85, 1000); //delete all after 100th char
    x = x.join('');
    // if the result differs from the input, add a title attr showing the desc in full
    return (x == desc ? x : `<span title='${desc}'>${x}</span>`)
}



function mass_style(q, style, value) {
    for (let i of qsa(q)) {
        i.style[style] = value;
    }
}

// function width_control() {
//   const w = qs('html').offsetWidth;

//   if (w <= 625) {
//     mass_style('.link-desc', 'width', w-100);
//     mass_style('.link-img', 'display', 'none');
//   } else {
//     mass_style('.link-desc', 'width', '');
//     mass_style('.link-img', 'display', '');
//   }
// }

// window.onresize = width_control;

// width_control()

function login_dropdown() {
    var list = [];
    if (sessionStorage.loggedin) {
        list.push({ name: 'Log Out', func: logout });
        list.push({ name: 'Order', func: () => { window.location = "order.html" } });
    }
    else {
        list.push({ name: 'Log In', func: () => { window.location = "login.html" } });
        list.push({ name: 'Sign Up', func: () => { window.location = "signup.html" } });
        list.push({ name: 'Order', func: () => { window.location = "login.html?redirect=order.html" } })
    }
    for (let i of list) {
        var tr = document.createElement("tr"),
            td = document.createElement("td"),
            text = document.createTextNode(i.name);
        td.classList.add('hover-change');
        td.appendChild(text);
        tr.appendChild(td);
        qs("#options tbody").appendChild(tr);
        qsa('td.hover-change')[
            qsa('td.hover-change').length - 1
        ].addEventListener('click', i.func)

    }
}

function meal_dropdowns(n = 0) {
    var select = qsa('.meal-select')[n];
    for (let [k, v] of Object.entries(menu)) {
        if (k) {
            let o = document.createElement('option'),
                t = document.createTextNode(k);
            o.setAttribute('disabled', '');
            o.appendChild(t);
            select.appendChild(o);
            for (let [key, val] of Object.entries(v)) {

                let o = document.createElement('option'),
                    t = document.createTextNode(key);
                o.appendChild(t);
                select.appendChild(o);
            }
        } else {
            let o = document.createElement('option'),
                t = document.createTextNode(k);
            o.appendChild(t);
            select.appendChild(o);
        }

    }

    return select;
}

if (window.location.href.split('fyp.html').length > 1) {

    if (sessionStorage.loggedin) {
        window.location.href = "index.html";
    }

    //to solve onclick attr problem with extensions
    qs('#guest').addEventListener('click', guest);
}

function find_in_menu(key) {
    for (let k of Object.keys(menu)) {
        if (Object.keys(menu[k]).includes(key)) {
            return menu[k][key]
        }
    }
    return { price: 0, diets: [], rating: 0, desc: "" }
}